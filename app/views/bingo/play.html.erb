<div id="bingo">
  <center>
    <h1>
        <div class = "timer" ><span id="timestring"></span></div>
    </h1>

    <div class = "player-info"> Player Name: " <%= @player.name %>
    </div>

    <div class = "current-player">  </div>

    <div class="bingo-card">
      <% for i in 0..24 do %>
         <div class="bingo-square <%= "square-#{i}" %>"> &nbsp; </div>
      <% end %>
    </div>

    <div class="modal fade" id="win-modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" data-backdrop="static">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="modal-title" id="myModalLabel"><b>YOU WIN!</b></h2>
          </div>
          <div class="modal-body">
            <h3>Your final board:</h3>
            <br>
            <div class="bingo-card">
              <% for i in 0..24 do %>
               <div class="bingo-square <%= "square-#{i}" %>"> &nbsp; </div>
              <% end %>
            </div>
            <br>
            <div class="victory-message">
              Send a message to the losers:
              <input id="victory-text" type="text">
              <input class="btn btn-primary" id="victory-button" type="button" value="Send">
            </div>
          </div>
          <div class="modal-footer">
            <%= button_to "Back to Lobby", {controller: :lobby, action: :index}, {class: "btn btn-primary", method: 'get'} %>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="lose-modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" data-backdrop="static">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title" id="myModalLabel"><b>YOU LOSE :(</b></h3>
          </div>
          <div class="modal-body">
            <h3>The winning board:</h3>
            <br>
            <div class="bingo-card">
              <% for i in 0..24 do %>
               <div class="bingo-square <%= "square-#{i}" %>"> &nbsp; </div>
              <% end %>
            </div>
            <br>
            <div class="victory-message"> &nbsp; </div>
          </div>
          <div class="modal-footer">
            <%= button_to "Back to Lobby", {controller: :lobby, action: :index}, {class: "btn btn-primary", method: 'get'} %>
          </div>
        </div>
      </div>
    </div>

  </center>
</div>

<script>
  var hasBeenClicked = false
  function startTimer(duration, display) {
      var timer = duration, minutes, seconds;
      timestring = "You will combust in " + minutes + ":" + seconds + " seconds!"
      setInterval(function () {
          minutes = parseInt(timer / 60, 10);
          seconds = parseInt(timer % 60, 10);

          minutes = minutes < 10 ? "0" + minutes : minutes;
          seconds = seconds < 10 ? "0" + seconds : seconds;

          display.textContent = timestring

          if (hasBeenClicked == true) {
            timestring = "thx bruh -- now wait for other peeps"
            display.textContent = timestring
          }

          else if (timer > 0) {
            timer--
            timestring = "You will combust in " + timer + " seconds!"
            display.textContent = timestring
          }

          else if (timer == 0) {
            // DO SOMETHING
            timer--
          }

          else {
            timestring = "TIMES UP boob"
            display.textContent = timestring
          }
      }, 1000);
  }


  window.onload = function () {
      var fifteensecs = 15,
          display = document.querySelector('#timestring');
      startTimer(fifteensecs, display);
  };

  function send(type, message) {
    message = message || ""
    msg = {"type": type,
      "player": <%= @player.id %>,
      "room": <%= @room.id %>,
      "message": message};
    dispatcher.trigger("bingo_message", msg);
  }

  dispatcher.on_open = function() {
    send("join");
  };

  window.onbeforeunload = function() {
    send("leave");
  };

  dispatcher.bind(<%= @room.id.to_s %>, function(msg) {
    if(msg["type"] == "update") {
      updateBoard(msg);

      $(".current-player").text("Current Player: " + msg["turn"]["name"])

      $('.bingo-square').off( "click" );
      $('.bingo-square').click(function() {
        send("number", $(this).text());
        hasBeenClicked = true;
      });
    } else if(msg["type"] == "game_over") {
      if(<%=@player.id%> == msg["victor"]["id"]) {
        $('#win-modal').modal("show");
      } else {
        $('#lose-modal').modal("show");
      }
      
      for (var i = 0; i <= 24; i++) {
        var sqNum = msg["players"][msg["victor"]["id"]]["board"][Math.floor(i/5)][i%5]["number"];
        $(".square-" + i).text(sqNum);
        if(msg["players"][msg["victor"]["id"]]["board"][Math.floor(i/5)][i%5]["called"]) {
          $('.square-'+ i).addClass("called");
        }
      }

    } else if(msg["type"] == "victory_msg") {
      $('.victory-message').html("<b>" + msg["victor"]["name"] + ":</b> " + msg["message"]);
    }
  });

  function updateBoard(msg) {
    for (var i = 0; i <= 24; i++) {
      var sqNum = msg["players"][<%=@player.id%>]["board"][Math.floor(i/5)][i%5]["number"];
      $(".square-" + i).text(sqNum);
      if(msg["players"][<%=@player.id%>]["board"][Math.floor(i/5)][i%5]["called"]) {
        $('.square-'+ i).addClass("called");
      } else {
        $('.square-'+ i).removeClass("called");
      }
    }
  }

  $('#victory-button').click(function() {
    var msg = $('#victory-text').val() || "Wow, this must be what it's like to be a Tiger! GO TIGERS!"
    send("victory_msg", msg);
  });

</script>
